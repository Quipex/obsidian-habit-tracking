# План расширения тестов Habit Button

## Подготовка инфраструктуры
- [x] Доработать `tests/stubs/obsidian.ts`, если для будущих проверок UI потребуются моки `SliderComponent`/`TextComponent`.
- [x] Добавить в `tests/utils/habit-fixtures.ts` вспомогательную функцию, формирующую строки привычек с учётом текущего префикса из настроек.
- [x] Научить `bootstrapPlugin` принимать частичные настройки, чтобы легко конфигурировать плагин перед тестом.

## Актуализация существующих тестов
- [x] `meta-warnings.test.ts`: переключить фикстуры на новый helper, проверить предупреждения при использовании глобальных настроек `defaultGracePeriodHours` и `defaultWarningWindowHours`, а также блоковый override `warningWindowHours`.
- [ ] `habit-logging.test.ts`: добавить сценарий с переопределённым префиксом (`ritual`) и удостовериться, что запись добавляется с тегом `#ritual_*`.
- [ ] `render.test.ts`: расширить ожидания, убеждаясь, что DOM содержит кастомную иконку и CSS-переменные, выставленные через настройки.

## Новые тестовые наборы
1. **resolveOptions.test.ts**
   - [ ] Ошибочный блок без `title` → `renderError`.
   - [ ] Переопределения `dailyFolder`, `weeks/days`, смена раскладки.
   - [ ] Числа вне диапазона корректно клэмпятся, NaN → значения из настроек (включая `defaultWarningWindowHours`).
   - [ ] Проверка кастомных размеров клеток/точек и обрезки `templatePath`.

2. **tag-prefix.test.ts**
   - [ ] Префикс `ritual` формирует теги `#ritual_key` и правильно ищет записи.
   - [ ] Санитайз mixed-case и спецсимволов.
   - [ ] Разные привычки не конфликтуют по ключам.

3. **habit-stats.test.ts**
   - [ ] Фильтрация по `dailyFolder` (вложенная папка).
   - [ ] Несколько отметок в день увеличивают счётчик и streak.
   - [ ] Игнор файлов не формата YYYY-MM-DD.
   - [ ] Вычисление `allowedGapH` = `defaultGracePeriodHours + defaultWarningWindowHours`, приоритет блокового `warningWindowHours`.
   - [ ] Перебивает глобальный порог значением из блока.
   - [ ] `warningWindowHours = 0` отключает предупреждение.

4. **render-heatmap.test.ts**
   - [ ] Режим `row`: количество точек = `options.days`, последняя дата = сегодня.
   - [ ] Режим `grid`: сетка `weeks × 7`, будущие дни с классом `is-future`.
   - [ ] Проверка смещения начала недели при `weekStart: "sunday"`.
   - [ ] Валидация CSS-переменных (`--habit-cell-size` и т.п.).

5. **icon-behavior.test.ts**
   - [ ] Кастомная иконка отображается до отметки, затем заменяется на `✓` и возвращается при сбросе состояния.

6. **template-handling.test.ts**
   - [ ] Создание заметки с шаблоном (контент шаблона + пустая строка + запись).
   - [ ] Отсутствие шаблона → предупреждение в логах, запись всё равно создаётся.
   - [ ] Добавление к существующей заметке сохраняет перевод строки (`ensureTrailingNewline`).

7. **error-paths.test.ts**
   - [ ] Некорректный YAML → `renderError` без развешенных обработчиков.
   - [ ] Ошибка сохранения (`vault.append` выбрасывает) приводит к уведомлению `ui.noticeError`.

8. **locale-refresh.test.ts**
   - [ ] Язык `ru` переключает локаль через `applyLocale`.
   - [ ] `auto` берёт язык из настроек вольта/браузера.

9. **command-snippet.test.ts**
   - [ ] Команда вставки блока использует текущие настройки (`defaultLayout` и т.д.), а не захардкоженные значения.

10. **settings-ui.test.ts** (при необходимости)
    - [ ] Проверка пары «слайдер + числовой input»: во время ввода ограничение не мешает, по blur значение схлопывается в диапазон.
    - [ ] Пустой префикс превращается в `habit`.

## Регрессионные проверки
- [ ] Убедиться, что `flushPromises` обрабатывает новые асинхронные ветки (добавить вызов там, где ждём обновления DOM).
- [ ] Документировать потенциальные дальнейшие сценарии: мультигодовые данные, снапшоты DOM для сложного CSS.
