# План реализации групп привычек

## Архитектура
- [ ] Ввести `HabitRegistry`, который хранит данные о каждой привычке: `group`, `habitKey`, `options`, `stats`, `sourcePath`, timestamp последнего обновления.
- [ ] Карточка `habit-button` при монтировании регистрирует себя в реестре и обновляет запись при пересчёте статистики.
- [ ] `habit-button` очищает запись из реестра при размонтировании или выгрузке плагина.

## Компонент `habit-group`
- [ ] YAML-параметры: `title`, `group`, `habitsLocations` (путь или массив путей), `eagerScan` (true/false).
- [ ] По умолчанию группа читает данные из `HabitRegistry` и рендерит сводку `active/total`.
- [ ] Если `eagerScan: true` или в реестре нет записей для группы, компонент обходит указанные `habitsLocations`.
  - [ ] Локация может быть файлом, директорией или путём без расширения.
  - [ ] Для «без расширения» проверяем: 1) точное совпадение, 2) `.md`, 3) другие расширения в алфавитном порядке.
  - [ ] В каждом файле ищем блоки ` ```habit-button` с `group == target`, парсим YAML, считаем статистику через общий модуль и обновляем `HabitRegistry`.
- [ ] Группа отображает список или агрегат (`3/5 привычек со стриком`), использует актуальные `stats` из реестра или сканирования.

## Общий модуль ядра
- [ ] Вынести из `main.ts` функции: `parseHabitBlock`, `resolveHabitOptions`, `collectHabitStats` в отдельный модуль (например, `src/habit-core.ts`).
- [ ] Обеспечить переиспользование в карточке и в группе.
- [ ] Добавить тесты на новый модуль.

## События и обновления
- [ ] При успешном логировании привычки обновлять запись в `HabitRegistry` и оповещать активные группы (через `app.workspace.trigger`).
- [ ] Группа при получении события перерисовывает агрегат без полного сканирования (если нет `eagerScan`).
- [ ] Для `eagerScan` оставить возможность принудительного пересчёта (кнопка/командлет или автоматом по событию изменения файла).

## Кэширование сканов
- [ ] Сохранять хеш/mtime обработанных файлов, чтобы не перечитывать неизменённые файлы при каждом рендере.
- [ ] При изменении файла (через `metadataCache.on("changed")`) инвалидировать соответствующие записи реестра.

## Тестирование
- [ ] Тесты на `HabitRegistry`: регистрация, обновление, удаление, фильтрация по группе.
- [ ] Тесты на `habit-group` в сценариях: только реестр, только скан, `eagerScan` + реестр, дубликаты.
- [ ] Интеграционные тесты на обновление сводки после клика по привычке.

## UX и документация
- [ ] Обновить README: описать новый блок `habit-group`, формат `habitsLocations`, опцию `eagerScan`.
- [ ] Добавить подсказки в настройках (если потребуется глобальная конфигурация групп) и в блок-шаблоне команды.
